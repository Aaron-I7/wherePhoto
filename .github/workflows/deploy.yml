name: Deploy to Server

on:
  push:
    branches: [ "master", "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    # Frontend Build Test
    - name: Set up Node.js for Client
      uses: actions/setup-node@v3
      with:
        node-version: 22
        cache: 'npm'
        cache-dependency-path: client/package-lock.json

    - name: Install Client Dependencies
      working-directory: ./client
      run: npm ci

    - name: Build Client
      working-directory: ./client
      run: npm run build

    # Backend Install Test
    - name: Set up Node.js for Server
      uses: actions/setup-node@v3
      with:
        node-version: 22
        cache: 'npm'
        cache-dependency-path: server/package-lock.json

    - name: Install Server Dependencies
      working-directory: ./server
      run: npm ci

    # Docker Build Test
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build Docker Image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: false
        tags: wherephoto:latest

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    steps:
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        command_timeout: 30m
        script: |
          # 设置工作目录
          mkdir -p /opt/wherePhoto
          cd /opt/wherePhoto
          
          # 1. 强制清理旧代码，重新克隆 (解决 git 冲突和网络问题)
          # 使用 gitee 镜像或配置 git 代理可能更好，但这里先尝试重试机制
          echo "Cleaning up workspace..."
          rm -rf .git
          rm -f Dockerfile
          
          echo "Cloning repository..."
          for i in {1..3}; do
            git clone --depth 1 https://github.com/Aaron-I7/wherePhoto.git . && break || sleep 10
          done
          
          if [ ! -f "Dockerfile" ]; then
            echo "Error: Clone failed or Dockerfile missing"
            exit 1
          fi
          
          # 2. 构建 Docker 镜像 (带重试)
          echo "Building Docker image..."
          # 配置 Docker 镜像加速 (如果服务器在中国大陆)
          if [ ! -f "/etc/docker/daemon.json" ]; then
            echo '{"registry-mirrors":["https://docker.1panel.live", "https://hub.rat.dev"]}' > /etc/docker/daemon.json
            systemctl reload docker
          fi

          for i in {1..3}; do
            docker build -t wherephoto . && break || sleep 10
          done
          
          # 3. 停止并移除旧容器
          echo "Stopping old container..."
          docker stop wherephoto-app || true
          docker rm wherephoto-app || true
          
          # 4. 启动新容器
          echo "Starting new container..."
          docker run -d \
            -p 3000:3000 \
            --name wherephoto-app \
            -v /opt/wherePhoto/server/uploads:/app/uploads \
            --restart unless-stopped \
            wherephoto
            
          # 5. 验证运行状态
          sleep 5
          if [ "$(docker inspect -f '{{.State.Running}}' wherephoto-app)" = "true" ]; then
             echo "Deployment successful!"
          else
             echo "Deployment failed: Container is not running"
             docker logs wherephoto-app
             exit 1
          fi
          
          # 6. 清理未使用的镜像
          docker image prune -f
