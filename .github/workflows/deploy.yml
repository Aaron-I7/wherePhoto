name: Deploy to Server

on:
  push:
    branches: [ "master", "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    # Frontend Build Test
    - name: Set up Node.js for Client
      uses: actions/setup-node@v3
      with:
        node-version: 22
        cache: 'npm'
        cache-dependency-path: client/package-lock.json

    - name: Install Client Dependencies
      working-directory: ./client
      run: npm ci

    - name: Build Client
      working-directory: ./client
      run: npm run build

    # Backend Install Test
    - name: Set up Node.js for Server
      uses: actions/setup-node@v3
      with:
        node-version: 22
        cache: 'npm'
        cache-dependency-path: server/package-lock.json

    - name: Install Server Dependencies
      working-directory: ./server
      run: npm ci

    # Docker Build Test
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build Docker Image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: false
        tags: wherephoto:latest

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    steps:
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        command_timeout: 30m
        script: |
          # ====================================================
          # Direct Node.js Deployment Script (No Docker)
          # ====================================================

          # 1. Environment Check
          echo "Checking environment..."
          if ! command -v node &> /dev/null; then
              echo "Error: Node.js is not installed."
              echo "Please install Node.js (v18+) on the server first."
              exit 1
          fi

          if ! command -v git &> /dev/null; then
              echo "Error: Git is not installed."
              echo "Please install Git on the server first."
              exit 1
          fi

          if ! command -v pm2 &> /dev/null; then
              echo "Installing PM2 globally..."
              npm install -g pm2
          fi

          # 2. Setup Workspace
          echo "Setting up workspace..."
          mkdir -p /opt/wherePhoto
          cd /opt/wherePhoto

          # 3. Pull Latest Code
          echo "Pulling latest code..."
          if [ ! -d ".git" ]; then
            git clone https://github.com/Aaron-I7/wherePhoto.git .
          else
            # Reset to avoid conflicts
            git fetch --all
            git reset --hard origin/master
          fi

          # 4. Install & Build Frontend
          echo "Building Frontend..."
          cd client
          npm install
          npm run build
          
          # Move build artifacts to server public directory
          echo "Deploying Frontend artifacts..."
          rm -rf ../server/public
          mkdir -p ../server/public
          cp -r dist/* ../server/public/

          # 5. Install Backend
          echo "Installing Backend dependencies..."
          cd ../server
          npm install --production

          # 6. Start/Restart Service via PM2
          echo "Starting Service..."
          # Check if app is running
          if pm2 describe wherephoto > /dev/null; then
              echo "Reloading existing service..."
              pm2 reload wherephoto
          else
              echo "Starting new service..."
              pm2 start index.js --name wherephoto
          fi
          
          # Save PM2 list to resurrect on reboot
          pm2 save
          
          echo "Deployment Complete!"
          echo "Service is running on port 3000"
