name: Deploy to Server

on:
  push:
    branches: [ "master", "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    # Frontend Build Test
    - name: Set up Node.js for Client
      uses: actions/setup-node@v3
      with:
        node-version: 22
        cache: 'npm'
        cache-dependency-path: client/package-lock.json

    - name: Install Client Dependencies
      working-directory: ./client
      run: npm ci

    - name: Build Client
      working-directory: ./client
      run: npm run build

    # Backend Install Test
    - name: Set up Node.js for Server
      uses: actions/setup-node@v3
      with:
        node-version: 22
        cache: 'npm'
        cache-dependency-path: server/package-lock.json

    - name: Install Server Dependencies
      working-directory: ./server
      run: npm ci

    # Docker Build Test
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build Docker Image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: false
        tags: wherephoto:latest

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    steps:
    # 1. Checkout Code
    - uses: actions/checkout@v3

    # 2. Build Frontend (Locally in Action)
    - name: Set up Node.js for Build
      uses: actions/setup-node@v3
      with:
        node-version: 22
        cache: 'npm'
        cache-dependency-path: client/package-lock.json

    - name: Build Frontend
      working-directory: ./client
      run: |
        npm ci
        npm run build

    # 3. Prepare Deployment Package
    - name: Prepare Deployment Artifacts
      run: |
        mkdir -p deploy_package/server
        # Copy Server Code
        cp -r server/* deploy_package/server/
        # Copy Frontend Build
        mkdir -p deploy_package/server/public
        cp -r client/dist/* deploy_package/server/public/
        # Remove local node_modules from server to avoid conflicts
        rm -rf deploy_package/server/node_modules
        # Create deployment script
        cat > deploy_package/deploy.sh << 'EOF'
        #!/bin/bash
        cd /opt/wherePhoto/server
        
        # Install dependencies
        echo "Installing production dependencies..."
        npm install --production --registry=https://registry.npmmirror.com

        # Start/Restart Service via PM2
        echo "Starting Service..."
        if ! command -v pm2 &> /dev/null; then
            npm install -g pm2 --registry=https://registry.npmmirror.com
        fi

        if pm2 describe wherephoto > /dev/null; then
            pm2 reload wherephoto
        else
            pm2 start index.js --name wherephoto
        fi
        pm2 save
        EOF

    # 4. Upload Files via SCP
    - name: Copy Files via SCP
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        source: "deploy_package/*"
        target: "/opt/wherePhoto_temp"
        strip_components: 1

    # 5. Execute Deployment Script
    - name: Execute Deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        script: |
          # Install Node.js if missing
          if ! command -v node &> /dev/null; then
              echo "Node.js not found. Installing Node.js 18..."
              if command -v yum &> /dev/null; then
                  # CentOS/Alibaba Cloud Linux
                  curl -fsSL https://rpm.nodesource.com/setup_18.x | bash -
                  yum install -y nodejs
              elif command -v apt-get &> /dev/null; then
                  # Ubuntu/Debian
                  curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
                  apt-get install -y nodejs
              else
                  echo "Error: Unknown package manager. Cannot install Node.js."
                  exit 1
              fi
          fi

          # Prepare Target Directory
          mkdir -p /opt/wherePhoto
          
          # Move files from temp to target (Atomic update)
          echo "Updating files..."
          rsync -av --delete /opt/wherePhoto_temp/ /opt/wherePhoto/
          rm -rf /opt/wherePhoto_temp

          # Run local deploy script
          echo "Running deploy script..."
          bash /opt/wherePhoto/deploy.sh
          
          echo "Deployment Success!"
